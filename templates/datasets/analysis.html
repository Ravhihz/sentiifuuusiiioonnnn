{% extends 'base.html' %}

{% block title %}Analysis - {{ dataset.name }}{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(248, 249, 250, 0.95); z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div class="text-center">
        <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4 class="mt-3">Loading Analysis...</h4>
        <p class="text-muted">Processing statistics...</p>
    </div>
</div>

<div class="container-fluid" style="opacity: 0;" id="mainContent">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fas fa-chart-bar"></i> Post-Preprocessing Analysis</h2>
            <p class="text-muted">{{ dataset.name }}</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'core:preprocessing_results' dataset.pk %}" class="btn btn-outline-info">
                <i class="fas fa-eye"></i> View Details
            </a>
            <a href="{% url 'core:dataset_detail' dataset.pk %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back
            </a>
            <a href="{% url 'core:dataset_label' dataset.pk %}" class="btn btn-primary">
                <i class="fas fa-tags"></i> Next: Labeling
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card" style="background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);">
                <div class="card-body text-center text-white">
                    <h3>{{ basic_stats.total_reviews }}</h3>
                    <p class="mb-0">Total Reviews</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card" style="background: linear-gradient(135deg, #059669 0%, #047857 100%);">
                <div class="card-body text-center text-white">
                    <h3>{{ preprocessed_stats.unique_tokens }}</h3>
                    <p class="mb-0">Unique Tokens</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card" style="background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);">
                <div class="card-body text-center text-white">
                    <h3>{{ preprocessed_stats.avg_tokens_per_review|floatformat:1 }}</h3>
                    <p class="mb-0">Avg Tokens/Review</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card" style="background: linear-gradient(135deg, #d97706 0%, #b45309 100%);">
                <div class="card-body text-center text-white">
                    <h3>{{ basic_stats.labeled_reviews }}</h3>
                    <p class="mb-0">Labeled Reviews</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Quality Report -->
    {% if quality_report and quality_report.before %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-chart-line"></i> Data Quality Report (Before vs After Preprocessing)
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-muted">Before Preprocessing</h5>
                            <table class="table table-sm">
                                <tr>
                                    <th>Total Reviews:</th>
                                    <td>{{ quality_report.before.total_reviews }}</td>
                                </tr>
                                <tr>
                                    <th>Empty Reviews:</th>
                                    <td><span class="badge bg-danger">{{ quality_report.before.empty_reviews }}</span></td>
                                </tr>
                                <tr>
                                    <th>Duplicates:</th>
                                    <td><span class="badge bg-warning text-dark">{{ quality_report.before.duplicate_count }}</span></td>
                                </tr>
                                <tr>
                                    <th>Invalid Characters:</th>
                                    <td><span class="badge bg-warning text-dark">{{ quality_report.before.invalid_chars_count }}</span></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-success">After Preprocessing</h5>
                            <table class="table table-sm">
                                <tr>
                                    <th>Processed Reviews:</th>
                                    <td><span class="badge bg-success">{{ quality_report.after.total_processed }}</span></td>
                                </tr>
                                <tr>
                                    <th>Removed Reviews:</th>
                                    <td><span class="badge bg-danger">{{ quality_report.after.removed_reviews }}</span></td>
                                </tr>
                                <tr>
                                    <th>Removal Rate:</th>
                                    <td><span class="badge bg-info">{{ quality_report.after.removal_percentage|floatformat:2 }}%</span></td>
                                </tr>
                            </table>
                            
                            <div class="alert alert-success mb-0 mt-3">
                                <small>
                                    <i class="fas fa-check-circle"></i> 
                                    <strong>{{ quality_report.after.total_processed }}</strong> clean reviews ready for labeling!
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Labeling Status Info -->
    <div class="row mb-4">
        <div class="col-12">
            {% if basic_stats.labeled_reviews > 0 %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> 
                <strong>{{ basic_stats.labeled_reviews }}</strong> reviews have been labeled. 
                <a href="{% url 'core:dataset_label' dataset.pk %}" class="alert-link">Continue labeling â†’</a>
                
                {% if imbalance_check and imbalance_check.is_imbalanced %}
                <div class="mt-2 pt-2 border-top">
                    <i class="fas fa-exclamation-triangle text-warning"></i> 
                    <strong>Dataset is imbalanced!</strong> 
                    Consider using SMOTE during training.
                    <ul class="mb-0 mt-1">
                        <li>Max class ({{ imbalance_check.max_class }}): {{ imbalance_check.max_count }}</li>
                        <li>Min class ({{ imbalance_check.min_class }}): {{ imbalance_check.min_count }}</li>
                        <li>Imbalance ratio: {{ imbalance_check.ratio|floatformat:2 }}</li>
                    </ul>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> 
                <strong>No labels yet.</strong> Start labeling reviews to train sentiment analysis model.
                <a href="{% url 'core:dataset_label' dataset.pk %}" class="btn btn-warning btn-sm ms-2">
                    <i class="fas fa-play"></i> Start Labeling
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Top Words & Text Length Statistics -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-list-ol"></i> Top 20 Tokens (After Preprocessing)
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead class="sticky-top bg-white">
                                <tr>
                                    <th style="width: 15%;">#</th>
                                    <th style="width: 60%;">Token</th>
                                    <th style="width: 25%;">Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for token in preprocessed_stats.top_tokens %}
                                <tr>
                                    <td class="text-muted">{{ forloop.counter }}</td>
                                    <td><code class="text-primary">{{ token.token }}</code></td>
                                    <td><strong>{{ token.count|floatformat:0 }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="alert alert-info mb-0 mt-3">
                        <small>
                            <i class="fas fa-info-circle"></i>
                            Total vocabulary: <strong>{{ preprocessed_stats.unique_tokens }}</strong> unique tokens
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-text-height"></i> Text Length Statistics
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th style="width: 50%;">Minimum Length:</th>
                            <td>{{ basic_stats.text_length.min }} words</td>
                        </tr>
                        <tr>
                            <th>Maximum Length:</th>
                            <td>{{ basic_stats.text_length.max }} words</td>
                        </tr>
                        <tr>
                            <th>Average Length:</th>
                            <td><strong>{{ basic_stats.text_length.avg|floatformat:1 }}</strong> words</td>
                        </tr>
                        <tr>
                            <th>Median Length:</th>
                            <td>{{ basic_stats.text_length.median }} words</td>
                        </tr>
                    </table>

                    <div class="alert alert-info mb-0 mt-3">
                        <small>
                            <i class="fas fa-info-circle"></i>
                            Average text reduction after preprocessing:<br>
                            <strong>{{ dataset.preprocessing_stats.avg_length_before|floatformat:1 }}</strong> 
                            <i class="fas fa-arrow-right text-muted"></i> 
                            <strong>{{ dataset.preprocessing_stats.avg_length_after|floatformat:1 }}</strong> words
                            <span class="badge bg-success ms-2">
                                -{{ dataset.preprocessing_stats.avg_length_before|floatformat:0|add:dataset.preprocessing_stats.avg_length_after|floatformat:0|add:"-"|add:dataset.preprocessing_stats.avg_length_after|floatformat:0 }} words
                            </span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Hide loading overlay and show content when everything is loaded
window.addEventListener('load', function() {
    console.log('Page fully loaded');
    
    // Get elements
    const overlay = document.getElementById('loadingOverlay');
    const content = document.getElementById('mainContent');
    
    // Check if elements exist
    if (overlay && content) {
        // Fade out loading overlay
        overlay.style.transition = 'opacity 0.3s';
        overlay.style.opacity = '0';
        
        setTimeout(function() {
            overlay.style.display = 'none';
            content.style.transition = 'opacity 0.5s';
            content.style.opacity = '1';
        }, 300);
    }
});
</script>
{% endblock %}
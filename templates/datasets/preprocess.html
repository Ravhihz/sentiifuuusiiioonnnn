{% extends 'base.html' %}

{% block title %}Preprocess Dataset - SentiFusion{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-broom"></i> Preprocess Dataset</h2>
            <p class="text-muted">{{ dataset.name }}</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-cog"></i> Preprocessing Configuration
                </div>
                <div class="card-body">
                    <form method="post" id="preprocessForm">
                        {% csrf_token %}
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Preprocessing Steps:</strong>
                            <ol class="mb-0 mt-2">
                                <li>Text Cleaning (lowercase, remove URLs, mentions)</li>
                                <li>Slang Normalization</li>
                                <li>Stopwords Removal</li>
                                <li>Stemming (Sastrawi) - <em>Optional, can be disabled</em></li>
                                <li>Feature Extraction (FastText)</li>
                            </ol>
                        </div>

                        <div class="mb-3">
                            <h5>Dataset Information:</h5>
                            <ul>
                                <li><strong>Total Reviews:</strong> {{ dataset.total_reviews }}</li>
                                <li><strong>Already Preprocessed:</strong> 
                                    {% if dataset.is_preprocessed %}
                                        <span class="badge bg-success">Yes</span>
                                    {% else %}
                                        <span class="badge bg-secondary">No</span>
                                    {% endif %}
                                </li>
                            </ul>
                        </div>

                        {% if dataset.is_preprocessed %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <strong>Dataset Already Preprocessed!</strong>
                            <p class="mb-0 mt-2">This dataset has been preprocessed successfully. You can view the analysis or re-run preprocessing to update results.</p>
                        </div>

                        <!-- Show Quick Actions if Already Preprocessed -->
                        <div class="card border-success mb-3">
                            <div class="card-header bg-success text-white">
                                <i class="fas fa-check-double"></i> Preprocessing Complete
                            </div>
                            <div class="card-body">
                                {% if dataset.preprocessing_stats %}
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted mb-1">Processed</h6>
                                                <h3 class="mb-0">{{ dataset.preprocessing_stats.processed }}</h3>
                                                <small class="text-muted">reviews</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted mb-1">Avg Tokens</h6>
                                                <h3 class="mb-0">{{ dataset.preprocessing_stats.avg_length_after|floatformat:1 }}</h3>
                                                <small class="text-muted">words/review</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <div class="d-grid gap-2">
                                    <a href="{% url 'core:preprocessing_results' dataset.pk %}" class="btn btn-primary btn-lg">
                                        <i class="fas fa-eye"></i> View Preprocessing Details
                                    </a>
                                    <a href="{% url 'core:dataset_detail' dataset.pk %}" class="btn btn-outline-secondary">
                                        <i class="fas fa-database"></i> Back to Dataset
                                    </a>
                                    <a href="{% url 'core:dataset_label' dataset.pk %}" class="btn btn-outline-info">
                                        <i class="fas fa-tags"></i> Start Labeling
                                    </a>
                                </div>

                                <hr class="my-3">

                                <div class="alert alert-warning mb-0">
                                    <small>
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <strong>Want to re-run preprocessing?</strong><br>
                                        Click "Start Preprocessing" below to overwrite current results.
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Preprocessing Options -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <i class="fas fa-sliders-h"></i> Options
                            </div>
                            <div class="card-body">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="use_stemming" name="use_stemming" checked>
                                    <label class="form-check-label" for="use_stemming">
                                        <strong>Enable Stemming (Sastrawi)</strong>
                                        <br>
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle"></i> 
                                            Stemming improves accuracy but takes longer (adds ~30-50% processing time).
                                            <br>
                                            For 10,000+ reviews: stemming may add 2-5 minutes.
                                        </small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Timer Display (hidden initially) -->
                        <div id="timerCard" class="card mb-3" style="display: none;">
                            <div class="card-header bg-primary text-white">
                                <i class="fas fa-clock"></i> Processing...
                            </div>
                            <div class="card-body text-center">
                                <h3 id="timer" class="mb-2">00:00</h3>
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         style="width: 100%">
                                        Processing...
                                    </div>
                                </div>
                                <p class="mt-3 mb-0">
                                    <small class="text-muted">
                                        <i class="fas fa-spinner fa-spin"></i> 
                                        Please wait... This may take several minutes.
                                    </small>
                                </p>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <i class="fas fa-play"></i> Start Preprocessing
                            </button>
                            <a href="{% url 'core:dataset_detail' dataset.pk %}" class="btn btn-secondary" id="cancelBtn">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-clock"></i> Estimated Time
                </div>
                <div class="card-body">
                    <p>Based on dataset size:</p>
                    <ul>
                        <li><strong>{{ dataset.total_reviews }}</strong> reviews</li>
                        <li id="estimateWithStemming">
                            <strong>With stemming:</strong> 
                            {% widthratio dataset.total_reviews 1000 1 %}-{% widthratio dataset.total_reviews 1000 2 %} minutes
                        </li>
                        <li id="estimateWithoutStemming">
                            <strong>Without stemming:</strong> 
                            {% widthratio dataset.total_reviews 1500 1 %}-{% widthratio dataset.total_reviews 1500 2 %} minutes
                        </li>
                    </ul>
                    
                    <div class="alert alert-info mt-3">
                        <small>
                            <i class="fas fa-lightbulb"></i>
                            <strong>Tip:</strong> For large datasets (10k+ reviews), consider disabling stemming for faster processing.
                        </small>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <i class="fas fa-info-circle"></i> Processing Details
                </div>
                <div class="card-body">
                    <small>
                        Preprocessing will:
                        <ul>
                            <li>Clean and normalize text</li>
                            <li>Remove stopwords</li>
                            <li>Apply stemming (if enabled)</li>
                            <li>Train FastText word embeddings</li>
                            <li>Extract 300-dim feature vectors</li>
                            <li>Save results to database</li>
                        </ul>
                        
                        <div class="alert alert-warning mb-0 mt-2">
                            <i class="fas fa-exclamation-circle"></i>
                            <strong>Do not close this page</strong> during processing!
                        </div>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let timerInterval = null;
let statusCheckInterval = null;
let startTime;

// Update estimates when stemming checkbox changes
document.getElementById('use_stemming').addEventListener('change', function() {
    const withStem = document.getElementById('estimateWithStemming');
    const withoutStem = document.getElementById('estimateWithoutStemming');
    
    if (this.checked) {
        withStem.style.fontWeight = 'bold';
        withoutStem.style.fontWeight = 'normal';
    } else {
        withStem.style.fontWeight = 'normal';
        withoutStem.style.fontWeight = 'bold';
    }
});

document.getElementById('preprocessForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    console.log('Starting preprocessing via AJAX...');
    
    // Get references
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const timerCard = document.getElementById('timerCard');
    
    // Disable and hide buttons
    submitBtn.disabled = true;
    submitBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
    
    // Show only timer card
    timerCard.style.display = 'block';
    
    // Start timer
    startTime = Date.now();
    timerInterval = setInterval(updateTimer, 100);
    
    // Scroll to timer
    setTimeout(() => {
        timerCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 300);
    
    // Get form data
    const useStemming = document.getElementById('use_stemming').checked;
    
    // Start preprocessing via AJAX
    fetch('{% url "core:start_preprocessing" dataset.pk %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
            'use_stemming': useStemming ? 'true' : 'false'
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Response:', data);
        
        if (data.status === 'completed') {
            // Processing done!
            console.log('✅ Preprocessing completed!', data.stats);
            
            // Stop timer
            clearInterval(timerInterval);
            timerInterval = null;
            
            // Show success
            showSuccess(data.stats);
            
        } else if (data.status === 'error') {
            // Error occurred
            clearInterval(timerInterval);
            timerInterval = null;
            
            console.error('Preprocessing error:', data.message);
            alert('Error during preprocessing:\n\n' + data.message + '\n\nCheck browser console for details.');
            if (data.traceback) {
                console.error('Traceback:', data.traceback);
            }
            location.reload();
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        clearInterval(timerInterval);
        timerInterval = null;
        alert('Network error: ' + error.message + '\n\nCheck browser console for details.');
        location.reload();
    });
    
    return false;
});

function updateTimer() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    
    const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    document.getElementById('timer').textContent = display;
}

function showSuccess(stats) {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    const finalTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    
    const timerCard = document.getElementById('timerCard');
    timerCard.outerHTML = `
        <div class="card border-success mb-3" id="successCard">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle"></i> Completed in ${finalTime}!
                </h5>
            </div>
            <div class="card-body">
                ${stats ? `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-1">Processed</h6>
                                <h3 class="mb-0">${stats.processed || 0}</h3>
                                <small class="text-muted">reviews</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-1">Removed</h6>
                                <h3 class="mb-0">${stats.removed || 0}</h3>
                                <small class="text-muted">duplicates/invalid</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info mb-3">
                    <strong><i class="fas fa-info-circle"></i> Processing Details:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Stemming: <strong>${stats.use_stemming ? '✅ Enabled' : '❌ Disabled'}</strong></li>
                        <li>Total time: <strong>${stats.processing_time ? stats.processing_time + 's' : finalTime}</strong></li>
                        <li>Feature vectors: <strong>300-dimensional</strong></li>
                    </ul>
                </div>
                ` : ''}
                
                <div class="d-grid gap-2">
                    <a href="{% url 'core:preprocessing_results' dataset.pk %}" class="btn btn-primary btn-lg">
                        <i class="fas fa-eye"></i> View Preprocessing Details
                    </a>
                    <a href="{% url 'core:dataset_detail' dataset.pk %}" class="btn btn-outline-secondary">
                        <i class="fas fa-database"></i> Back to Dataset
                    </a>
                    <a href="{% url 'core:dataset_label' dataset.pk %}" class="btn btn-outline-info">
                        <i class="fas fa-tags"></i> Start Labeling
                    </a>
                </div>
            </div>
        </div>
    `;
}

// Prevent accidental page close ONLY during processing
window.addEventListener('beforeunload', function(e) {
    if (timerInterval !== null) {
        e.preventDefault();
        e.returnValue = 'Processing in progress. Are you sure you want to leave?';
        return e.returnValue;
    }
});

// Cleanup
window.addEventListener('unload', function() {
    if (timerInterval) clearInterval(timerInterval);
    if (statusCheckInterval) clearInterval(statusCheckInterval);
});
</script>
{% endblock %}